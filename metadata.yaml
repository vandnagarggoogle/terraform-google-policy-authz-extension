apiVersion: blueprints.cloud.google.com/v1alpha1
kind: BlueprintMetadata
metadata:
  name: terraform-google-policy-authz-extension
  annotations:
    config.kubernetes.io/local-config: "true"
spec:
  info:
    title: terraform-google-policy-authz-extension
    source:
      repo: https://github.com/vandnagarggoogle/terraform-google-policy-authz-extension.git
      sourceType: git
    version: 0.0.16
    actuationTool:
      flavor: Terraform
      version: ">= 0.13"
    description:
      tagline: This is an auto-generated module.
      detailed: "This module was generated from "
      preDeploy: To deploy this blueprint you must have an active billing account and billing permissions.
    icon: assets/icon.png
    costEstimate:
      description: Blueprint cost details
      url: https://cloud.google.com/products/calculator?id=02fb0c45-cc29-4567-8cc6-f72ac9024add
  content:
    architecture:
      diagramUrl: https://www.link-to-architecture-diagram.com
      description:
        - 1. Architecture description step no. 1
        - 2. Architecture description step no. 2
        - 3. Architecture description step no. N
    documentation:
      - title: Hosting a Static Website
        url: https://cloud.google.com/storage/docs/hosting-static-website
    examples:
      - name: simple_example
        location: examples/simple_example
  interfaces:
    variables:
      - name: project_id
        varType: string
        required: true
      - name: location
        varType: string
        required: true
      - name: extensions_config
        description: List of unique security logic modules.
        varType: |-
          list(object({
              name                  = string
              authority             = string
              backend_service       = string
              load_balancing_scheme = string
              description           = optional(string, "Managed by ADC")
              timeout               = optional(string, "0.1s")
              fail_open             = optional(bool, false)
            }))
        required: true
      - name: policies_config
        description: A list of Authz Policies with structured HTTP rules.
        varType: |-
          list(object({
              name                  = string
              action                = string
              load_balancing_scheme = string
              target_resources      = list(string)
              description           = optional(string, "Managed by ADC")
              extension_names       = optional(list(string), [])
              
              http_rules = optional(list(object({
                when = optional(string)
                from = optional(object({
                  not_sources = optional(list(object({
                    ip_blocks = optional(list(object({
                      prefix = string
                      length = number
                    })), [])
                    principals = optional(list(object({
                      principal_selector = optional(string, "CLIENT_CERT_URI_SAN")
                      principal = optional(object({
                        exact       = optional(string)
                        ignore_case = optional(bool, true)
                      }))
                    })), [])
                  })), [])
                }))
                to = optional(object({
                  operations = optional(list(object({
                    methods = optional(list(string), [])
                    paths   = optional(list(object({ exact = string })), [])
                    header_set = optional(list(object({
                      headers = optional(list(object({
                        name = string
                        value = optional(object({
                          exact       = string
                          ignore_case = optional(bool, true)
                        }))
                      })), [])
                    })), [])
                  })), [])
                }))
              })), [])
            }))
        required: true
    outputs:
      - name: extension_ids
        description: Map of extension names to their unique resource IDs.
        type: map(string) 
      - name: policy_extension_map
        description: Maps each policy name to its single assigned extension ID.
        type: map(string)
      - name: policy_ids
        description: Map of policy names to their unique resource IDs.
        type: map(list(string))
  requirements:
    roles:
      - level: Project
        roles:
          - roles/owner
    services:
      - cloudresourcemanager.googleapis.com
      - storage-api.googleapis.com
      - serviceusage.googleapis.com
    providerVersions:
      - source: hashicorp/google
        version: ">= 5.36, < 8"
      - source: hashicorp/google-beta
        version: ">= 5.36, < 8"
